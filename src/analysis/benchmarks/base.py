from abc import ABC, abstractmethod
from pathlib import Path
import h5py

class BaseBenchmarkResult(ABC):
    """
    Base class for results generated by a benchmark.

    It provides helper methods to locate standard files and directories
    within a given experiment directory.
    """
    def __init__(self, experiment_dir: Path):
        self.experiment_dir = experiment_dir
        if not self.experiment_dir.is_dir():
            raise FileNotFoundError(f"Experiment directory not found: {self.experiment_dir}")

    @property
    def output_dir(self) -> Path:
        return self.experiment_dir / "output"

    @property
    def metrics_dir(self) -> Path:
        return self.experiment_dir / "metrics"

    @property
    def readout_path(self) -> Path:
        # Note: Assumes a single readout file. May need adjustment if multiple
        # readouts per experiment are supported in the future.
        try:
            return next(self.output_dir.glob("readout_*.h5"))
        except StopIteration:
            raise FileNotFoundError(f"No readout file found in {self.output_dir}")

    @property
    def simulation_path(self) -> Path:
        sim_path = self.output_dir / "simulation.h5"
        if not sim_path.exists():
            raise FileNotFoundError(f"simulation.h5 not found in {self.output_dir}")
        return sim_path

    def get_metrics_path(self, filename: str = "metrics.h5") -> Path:
        """Determines the path to the metrics.h5 file."""
        self.metrics_dir.mkdir(parents=True, exist_ok=True)
        return self.metrics_dir / filename

    @abstractmethod
    def save(self) -> Path:
        """
        Saves the benchmark result(s) to the project's standard
        metrics.h5 file and returns the path to that file.
        """
        pass


class BaseBenchmark(ABC):
    """Abstract interface for all benchmark definitions."""
    
    @abstractmethod
    def run(self, experiment_dir: Path, **kwargs) -> BaseBenchmarkResult:
        """
        Runs the benchmark against an experiment's data.

        Args:
            experiment_dir (Path): The path to the root experiment directory.
                The benchmark can access any file within this directory
                (e.g., `simulation.h5`, `readout.h5`, `config.json`).
            **kwargs: Additional keyword arguments specific to the benchmark.

        Returns:
            BaseBenchmarkResult: An object containing the benchmark results,
                                 ready to be saved.
        """
        pass
